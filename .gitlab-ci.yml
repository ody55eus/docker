image: docker:stable
services:
- docker:dind
stages:
- emacs
- publish
- ana
variables:
  CI_REGISTRY_BASE: ${CI_REGISTRY}/${CI_PROJECT_PATH}
before_script:
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

img-emacs-latest:
  stage: emacs
  variables:
    CI_REGISTRY_IMAGE: ${CI_REGISTRY_BASE}/emacs-latest
    CI_PATH: emacs-latest
  script:
    - docker build -t $CI_REGISTRY_IMAGE $CI_PATH
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  resource_group: group-emacs

img-publish:
  stage: publish
  variables:
    CI_REGISTRY_IMAGE: ${CI_REGISTRY_BASE}/publish
    CI_REGISTRY_PATH: publish
  script:
    - docker build -t $CI_REGISTRY_IMAGE $CI_REGISTRY_PATH
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  resource_group: group-emacs

img-ana:
  stage: ana
  variables:
    CI_REGISTRY_IMAGE: ${CI_REGISTRY_BASE}/ana
    CI_REGISTRY_PATH: ana
  script:
    - docker build -t $CI_REGISTRY_IMAGE:alpine $CI_REGISTRY_PATH/alpine
    - docker push $CI_REGISTRY_IMAGE:alpine
    - docker build -t $CI_REGISTRY_IMAGE:bookworm $CI_REGISTRY_PATH/bookworm
    - docker push $CI_REGISTRY_IMAGE:bookworm
  resource_group: group-emacs
